# h2 Break & unbreak

## x) Lue/katso/kuuntele ja tiivistä. 

#### OWASP: OWASP Top 10: A01 Broken Access Control

- Pääsynhallinta (Access Control) tarkoittaa sääntöjä ja rajoituksia, jotka määrittelevät, että mitä käyttäjät voivat tehdä tai mihin tietoihin he voivat päästä.
- Kun pääsynhallinta rikkoutuu niin on mahdollista päästä käsiksi tietoon, joka ei kuulu kyseisen henkilön nähtäväksi, muokattavaksi tai poistettavaksi.

#### Karvinen 2023: Find Hidden Web Directories - Fuzz URLs with ffuf

- Verkkopalvelimilla on usein piilotettuja hakemistoja (esim. /secret, /admin), joita ei linkitetä näkyvästi.
- Ffuf on työkalu, joka etsii piilotettuja hakemistoja automaattisesti.
  - Sanakirja taustalla mahdollisista kansioista.
  - Kannattaa irroittaa kone netistä työkalun käytön ajaksi.
  - Tutoriaali toimi myös Kalilla.

#### PortSwigger: Access control vulnerabilities and privilege escalation

- Autentikointi: vahvistaa, että käyttäjä on se, joka hän väittää olevansa.
- Session management: tunnistaa, mitkä seuraavat HTTP-pyynnöt tulevat samalta käyttäjältä.
- Pääsynhallinta: määrittää, onko käyttäjällä oikeus suorittaa toiminto, jota hän yrittää tehdä.

- Vertikaaliset pääsynhallinnat
  - rajoittavat pääsyn arkaluontoisiin toimintoihin tietyille käyttäjätyypeille.(admin vs user)

- Horinsontaaliset pääsynhallinnat
  - rajoittavat pääsyn resursseihin tietyille käyttäjille. (vain omat tiedot)

- Kontekstiriippuvaiset pääsynhallinnat
  - rajoittavat pääsyä toimintoihin ja resursseihin sovelluksen tilan tai käyttäjän toiminnan perusteella. (toiminnoilla oikea järjestys)


#### Karvinen 2006: Raportin kirjoittaminen

#### Vapaaehtoinen: PortSwigger 2020: What is SQL injection? - Web Security Academy (noin 10 min video)

## a) Murtaudu 010-staff-only. 

Hain zipin, purin sen ja käynnistin 010-staff-only.

![1](https://github.com/user-attachments/assets/0b8206b7-08d4-42dd-beb3-923e992adfe6)

![2](https://github.com/user-attachments/assets/cc483d28-fbdc-4072-a698-0324c31307d7)

Alkuun ihmetystä herätti, kun kenttä vaati numeroarvon syöttämisen. Päätin katsoa, että mitä developer tools kertoo syöttökentästä. Input type oli siellä määritelty numeroksi, joten päätin kokeilla saisiko sen selaimessa muutettua tekstiksi (text). Tämä onnistui, jolloin onnistuin myös syöttämään pelkän numeron lisäksi muuta tavaraa kenttään ja napin painallus ei suoraan hylännyt syötettä.

![3](https://github.com/user-attachments/assets/b9093918-887a-4103-9c81-75418be1d842)
![5](https://github.com/user-attachments/assets/eeb36de6-7c90-4355-bde6-942469f605ad)


Vinkissä oli, että SUPERADMIN sisältyy salasanaan sekä lisäksi oli kerrottu, että pins taulussa on password. Lähdin siis testaamaan, että kuinka saisin sql-injektion joka sisältää SUPERADMIN että password. Päädyin seuraavaan syötteeseen:

    0' OR password LIKE '%SUPERADMIN%'--

- Tässä syötteessä ensin on **0'** , joka tässä tapauksessa on tekstiä. 
- **password LIKE '%SUPERADMIN%'**: Password-kentässä tulee olla SUPERADMIN ja %-merkit kertovat, että sitä ennen ja jälkeen voi olla jotain muuta. Hipsut viittaavat merkkijonoon.
- **--**: Kommentti, jolloin perässä tulevaa ei enää suoriteta.

Tämä pyöräytti minulle passwordin:

![4](https://github.com/user-attachments/assets/09e1fa9f-fc3e-47ce-92d7-f612d246a37a)

## b) Korjaa 010-staff-only haavoittuvuus lähdekoodista. 

Vinkeissä oli mainittu SQLAlchemy ja lähdin tutkimaan tätä hieman tarkemmin. Netistä löytämäni materiaalit tuntuivat varsin monimutkaisilta, joten päädyin kysymään apua ChatGTP:ltä. Kerroin, että minulla on tällainen toimiva injektio, joten miten koodia tulisi muuttaa.  

Koodissa pin oli syötetty suoraan sql-lauseeseen, joka mahdollistaa injektion tekemisen:

    sql = "SELECT password FROM pins WHERE pin='"+pin+"';"
    with app.app_context():
        res = db.session.execute(text(sql))

Parametrisoitu kysely erottaa syötteen sql-lauseeesta. Tällöin koko syötettä ajatellaan merkkijonona ilman, että sitä tulkitaan osaksi sql-koodia. **:pin** on kuin laatikko tai ajatusviiva, johon PIN asetetaan. Tämän jälkeen merkkijono asetetaan tarkastettavaksi. 

    sql = text("SELECT password FROM pins WHERE pin = :pin")
    with app.app_context():
        res = db.session.execute(sql, {'pin': pin})

Kun tein tämän muutokset ja muutin selaimessa "input type: text" sekä syötin uudelleen sql-injektion ei mitään löytynyt:

![6](https://github.com/user-attachments/assets/db50e17e-2776-4504-9366-b8f7786a3778)

## c) Ratkaise dirfuzt-1 artikkelista Karvinen 2023: Find Hidden Web Directories - Fuzz URLs with ffuf. 

Tämä auttaa 020-your-eyes-only ratkaisemisessa.

## d) Murtaudu 020-your-eyes-only. 

Ks. Karvinen 2024: Hack'n Fix

## e) Korjaa 020-your-eyes-only haavoittuvuus. 

Osoita testillä, että ratkaisusi toimii.

## g) Vapaaehtoinen. 

Johdantotehtävä, joka auttaa 010-staff-only ratkaisemisessa. Ratkaise Portswigger Academyn "Lab: SQL injection vulnerability in WHERE clause allowing retrieval of hidden data".

## h) Vapaaehtoinen. 

Johdantotehtävä, joka auttaa 010-staff-only ratkaisemisessa. Ratkaise Portswigger Academyn "Lab: SQL injection vulnerability allowing login bypass"
